# 4. Expressing HTTP Semantics in HTTP/3 / 在 HTTP/3 中表达 HTTP 语义

## 4.1. HTTP Message Framing / HTTP 消息分帧

> A client sends an HTTP request on a [request stream](https://www.rfc-editor.org/rfc/rfc9114.html#request-streams), which is a client-initiated bidirectional QUIC stream; see [Section 6.1](https://www.rfc-editor.org/rfc/rfc9114.html#request-streams). A client **MUST** send only a single request on a given stream. A server sends zero or more interim HTTP responses on the same stream as the request, followed by a single final HTTP response, as detailed below. See [Section 15](https://www.rfc-editor.org/rfc/rfc9110#section-15) of [[HTTP](https://www.rfc-editor.org/rfc/rfc9114.html#RFC9110)] for a description of interim and final HTTP responses.

客户端在请求流上发送 HTTP 请求，请求流是客户端发起的双向 QUIC 流； 见第 6.1 节。 客户端**必须**在给定的流上只发送一个请求。 服务器在与请求相同的流上发送零个或多个临时 HTTP 响应，然后是单个最终 HTTP 响应，如下所述。 有关临时和最终 HTTP 响应的描述，请参见 [HTTP] 的第 15 节。

> Pushed responses are sent on a server-initiated unidirectional QUIC stream; see [Section 6.2.2](https://www.rfc-editor.org/rfc/rfc9114.html#push-streams). A server sends zero or more interim HTTP responses, followed by a single final HTTP response, in the same manner as a standard response. Push is described in more detail in [Section 4.6](https://www.rfc-editor.org/rfc/rfc9114.html#server-push).

推送的响应在一个服务器发起的单向 QUIC 流上发送； 见第 6.2.2 节。 服务器以与标准响应相同的方式发送零个或多个临时 HTTP 响应，然后是单个最终 HTTP 响应。 推送在 4.6 节中有更详细的描述。

> On a given stream, receipt of multiple requests or receipt of an additional HTTP response following a final HTTP response **MUST** be treated as [malformed](https://www.rfc-editor.org/rfc/rfc9114.html#malformed).

在一个给定的流上，收到多个请求或在最终 HTTP 响应之后收到额外的 HTTP 响应**必须**被视为格式错误。

> An HTTP message (request or response) consists of:
>
> 1. the header section, including message control data, sent as a single [HEADERS](https://www.rfc-editor.org/rfc/rfc9114.html#frame-headers) frame,
> 2. optionally, the content, if present, sent as a series of [DATA](https://www.rfc-editor.org/rfc/rfc9114.html#frame-data) frames, and
> 3. optionally, the trailer section, if present, sent as a single [HEADERS](https://www.rfc-editor.org/rfc/rfc9114.html#frame-headers) frame.
>
> Header and trailer sections are described in Sections [6.3](https://www.rfc-editor.org/rfc/rfc9110#section-6.3) and [6.5](https://www.rfc-editor.org/rfc/rfc9110#section-6.5) of [[HTTP](https://www.rfc-editor.org/rfc/rfc9114.html#RFC9110)]; the content is described in [Section 6.4](https://www.rfc-editor.org/rfc/rfc9110#section-6.4) of [[HTTP](https://www.rfc-editor.org/rfc/rfc9114.html#RFC9110)].

一个 HTTP 消息（请求或响应）包括：

1. 首部，包括消息控制数据，作为单个 HEADERS 帧发送，
2. 可选地，内容（如果存在）作为一系列 DATA 帧发送，以及
3. 可选地，尾部（如果存在）作为单个 HEADERS 帧发送。

Header 和 Trailer 部分在 [HTTP] 的 6.3 和 6.5 节中描述； 内容在 [HTTP] 的第 6.4 节中描述。

> Receipt of an invalid sequence of frames **MUST** be treated as a [connection error](https://www.rfc-editor.org/rfc/rfc9114.html#errors) of type [H3_FRAME_UNEXPECTED](https://www.rfc-editor.org/rfc/rfc9114.html#H3_FRAME_UNEXPECTED). In particular, a [DATA](https://www.rfc-editor.org/rfc/rfc9114.html#frame-data) frame before any [HEADERS](https://www.rfc-editor.org/rfc/rfc9114.html#frame-headers) frame, or a [HEADERS](https://www.rfc-editor.org/rfc/rfc9114.html#frame-headers) or [DATA](https://www.rfc-editor.org/rfc/rfc9114.html#frame-data) frame after the trailing [HEADERS](https://www.rfc-editor.org/rfc/rfc9114.html#frame-headers) frame, is considered invalid. Other frame types, especially unknown frame types, might be permitted subject to their own rules; see [Section 9](https://www.rfc-editor.org/rfc/rfc9114.html#extensions).

接收到无效的帧序列**必须**被视为 H3_FRAME_UNEXPECTED 类型的连接错误。 特别的，任何 HEADERS 帧之前的 DATA 帧，或尾部 HEADERS 帧之后的 HEADERS 或 DATA 帧，都被认为是无效的。 其他帧类型，尤其是未知帧类型，可能会根据它们自己的规则被允许； 见第 9 节。

> A server **MAY** send one or more [PUSH_PROMISE](https://www.rfc-editor.org/rfc/rfc9114.html#frame-push-promise) frames before, after, or interleaved with the frames of a response message. These [PUSH_PROMISE](https://www.rfc-editor.org/rfc/rfc9114.html#frame-push-promise) frames are not part of the response; see [Section 4.6](https://www.rfc-editor.org/rfc/rfc9114.html#server-push) for more details. [PUSH_PROMISE](https://www.rfc-editor.org/rfc/rfc9114.html#frame-push-promise) frames are not permitted on [push streams](https://www.rfc-editor.org/rfc/rfc9114.html#push-streams); a pushed response that includes [PUSH_PROMISE](https://www.rfc-editor.org/rfc/rfc9114.html#frame-push-promise) frames **MUST** be treated as a [connection error](https://www.rfc-editor.org/rfc/rfc9114.html#errors) of type [H3_FRAME_UNEXPECTED](https://www.rfc-editor.org/rfc/rfc9114.html#H3_FRAME_UNEXPECTED).

服务器**可能**在响应消息的帧之前、之后或与响应消息的帧交错发送一个或多个 PUSH_PROMISE 帧。 这些 PUSH_PROMISE 帧不是响应的一部分； 有关详细信息，请参阅第 4.6 节。 推送流上不允许使用 PUSH_PROMISE 帧； 包含 PUSH_PROMISE 帧的推送响应**必须**被视为 H3_FRAME_UNEXPECTED 类型的连接错误。

> Frames of unknown types ([Section 9](https://www.rfc-editor.org/rfc/rfc9114.html#extensions)), including reserved frames ([Section 7.2.8](https://www.rfc-editor.org/rfc/rfc9114.html#frame-reserved)) **MAY** be sent on a request or [push stream](https://www.rfc-editor.org/rfc/rfc9114.html#push-streams) before, after, or interleaved with other frames described in this section.

未知类型的帧（第 9 节），包括保留帧（第 7.2.8 节）**可能**在请求或推送流之前、之后或与本节中描述的其他帧中交错发送。

> The [HEADERS](https://www.rfc-editor.org/rfc/rfc9114.html#frame-headers) and [PUSH_PROMISE](https://www.rfc-editor.org/rfc/rfc9114.html#frame-push-promise) frames might reference updates to the QPACK dynamic table. While these updates are not directly part of the message exchange, they must be received and processed before the message can be consumed. See [Section 4.2](https://www.rfc-editor.org/rfc/rfc9114.html#header-formatting) for more details.

HEADERS 和 PUSH_PROMISE 帧可能会引用对 QPACK 动态表的更新。 虽然这些更新不是消息交换的直接部分，但必须先接收和处理它们，然后才能消费消息。 有关详细信息，请参阅第 4.2 节。

> Transfer codings (see [Section 7](https://www.rfc-editor.org/rfc/rfc9112#section-7) of [[HTTP/1.1](https://www.rfc-editor.org/rfc/rfc9114.html#RFC9112)]) are not defined for HTTP/3; the Transfer-Encoding header field **MUST NOT** be used.

没有为 HTTP/3 定义传输编码（参见 [HTTP/1.1] 的第 7 节）； **不得**使用 Transfer-Encoding 头域。

> A response **MAY** consist of multiple messages when and only when one or more interim responses (1xx; see [Section 15.2](https://www.rfc-editor.org/rfc/rfc9110#section-15.2) of [[HTTP](https://www.rfc-editor.org/rfc/rfc9114.html#RFC9110)]) precede a final response to the same request. Interim responses do not contain content or trailer sections.

当且仅当一个或多个临时响应（1xx；参见 [HTTP] 的第 15.2 节）先于对同一请求的最终响应时，响应才**可能**包含多个消息。 临时响应不包含内容或尾部部分。

> An HTTP request/response exchange fully consumes a client-initiated bidirectional QUIC stream. After sending a request, a client **MUST** close the stream for sending. Unless using the CONNECT method (see [Section 4.4](https://www.rfc-editor.org/rfc/rfc9114.html#connect)), clients **MUST NOT** make stream closure dependent on receiving a response to their request. After sending a final response, the server **MUST** close the stream for sending. At this point, the QUIC stream is fully closed.

HTTP 请求/响应交换完全使用客户端发起的双向 QUIC 流。 发送请求后，客户端**必须**关闭要发送的流。 除非使用 CONNECT 方法（参见第 4.4 节），否则客户端**不得**依赖于接收到对其请求的响应来进行流关闭。 发送最终响应后，服务器**必须**关闭要发送的流。 此时，QUIC 流已完全关闭。

> When a stream is closed, this indicates the end of the final HTTP message. Because some messages are large or unbounded, endpoints **SHOULD** begin processing partial HTTP messages once enough of the message has been received to make progress. If a client-initiated stream terminates without enough of the HTTP message to provide a complete response, the server **SHOULD** abort its response stream with the error code [H3_REQUEST_INCOMPLETE](https://www.rfc-editor.org/rfc/rfc9114.html#H3_REQUEST_INCOMPLETE).

当一个流关闭时，这表示最终 HTTP 消息的结束。 由于某些消息很大或无界，端点**应该**在收到足够多的消息以取得进展后开始处理部分 HTTP 消息。 如果客户端发起的流在没有足够的 HTTP 消息来提供完整响应的情况下终止，则服务器**应该**使用错误代码 H3_REQUEST_INCOMPLETE 中止其响应流。

> A server can send a complete response prior to the client sending an entire request if the response does not depend on any portion of the request that has not been sent and received. When the server does not need to receive the remainder of the request, it **MAY** abort reading the [request stream](https://www.rfc-editor.org/rfc/rfc9114.html#request-streams), send a complete response, and cleanly close the sending part of the stream. The error code [H3_NO_ERROR](https://www.rfc-editor.org/rfc/rfc9114.html#H3_NO_ERROR) **SHOULD** be used when requesting that the client stop sending on the [request stream](https://www.rfc-editor.org/rfc/rfc9114.html#request-streams). Clients **MUST NOT** discard complete responses as a result of having their request terminated abruptly, though clients can always discard responses at their discretion for other reasons. If the server sends a partial or complete response but does not abort reading the request, clients **SHOULD** continue sending the content of the request and close the stream normally.

如果响应不依赖于尚未发送和接收的请求的任何部分，则服务器可以在客户端发送整个请求之前发送完整的响应。 当服务器不需要接收请求的剩余部分时，它**可以**中止读取请求流，发送完整的响应，并干净地关闭流的发送部分。 当请求客户端停止在请求流上发送时，应该使用错误代码 H3_NO_ERROR。 客户端**不能**因为他们的请求突然终止而丢弃完整的响应，尽管客户端总是可以出于其他原因自行决定丢弃响应。 如果服务器发送了部分或完整的响应但没有中止读取请求，客户端**应该**继续发送请求的内容并正常关闭流。

### 4.1.1. Request Cancellation and Rejection / 请求取消和拒绝

> Once a [request stream](https://www.rfc-editor.org/rfc/rfc9114.html#request-streams) has been opened, the request **MAY** be cancelled by either endpoint. Clients cancel requests if the response is no longer of interest; servers cancel requests if they are unable to or choose not to respond. When possible, it is **RECOMMENDED** that servers send an HTTP response with an appropriate status code rather than cancelling a request it has already begun processing.

一旦请求流被打开，请求**可以**被任一端点取消。 如果对响应不再感兴趣，客户会取消请求； 如果服务器无法响应或选择不响应，则服务器会取消请求。 如果可能，**建议**服务器发送带有适当状态代码的 HTTP 响应，而不是取消它已经开始处理的请求。

> Implementations **SHOULD** cancel requests by abruptly terminating any directions of a stream that are still open. To do so, an implementation resets the sending parts of streams and aborts reading on the receiving parts of streams; see [Section 2.4](https://www.rfc-editor.org/rfc/rfc9000#section-2.4) of [[QUIC-TRANSPORT](https://www.rfc-editor.org/rfc/rfc9114.html#QUIC-TRANSPORT)].

实现**应该**通过突然终止正开放流的任何方向来取消请求。 为此，实现会重置流的发送部分并中止对流的接收部分的读取； 参见 [QUIC-TRANSPORT] 的第 2.4 节。

> When the server cancels a request without performing any application processing, the request is considered "rejected". The server **SHOULD** abort its response stream with the error code [H3_REQUEST_REJECTED](https://www.rfc-editor.org/rfc/rfc9114.html#H3_REQUEST_REJECTED). In this context, "processed" means that some data from the stream was passed to some higher layer of software that might have taken some action as a result. The client can treat requests rejected by the server as though they had never been sent at all, thereby allowing them to be retried later.

当服务器取消请求而不执行任何应用程序处理时，该请求被视为“拒绝”。 服务器**应该**使用错误代码 H3_REQUEST_REJECTED 中止其响应流。 在这种情况下，“已处理”意味着来自流的一些数据被传递到某些更高层的软件，这些软件可能因此采取了一些行动。 客户端可以将被服务器拒绝的请求视为根本没有发送过，从而允许稍后重试它们。

> Servers **MUST NOT** use the [H3_REQUEST_REJECTED](https://www.rfc-editor.org/rfc/rfc9114.html#H3_REQUEST_REJECTED) error code for requests that were partially or fully processed. When a server abandons a response after partial processing, it **SHOULD** abort its response stream with the error code [H3_REQUEST_CANCELLED](https://www.rfc-editor.org/rfc/rfc9114.html#H3_REQUEST_CANCELLED).

对于部分或全部处理的请求，服务器**不得**使用 H3_REQUEST_REJECTED 错误代码。 当服务器在部分处理后放弃响应时，它**应该**以错误代码 H3_REQUEST_CANCELLED 中止其响应流。

> Client **SHOULD** use the error code [H3_REQUEST_CANCELLED](https://www.rfc-editor.org/rfc/rfc9114.html#H3_REQUEST_CANCELLED) to cancel requests. Upon receipt of this error code, a server **MAY** abruptly terminate the response using the error code [H3_REQUEST_REJECTED](https://www.rfc-editor.org/rfc/rfc9114.html#H3_REQUEST_REJECTED) if no processing was performed. Clients **MUST NOT** use the [H3_REQUEST_REJECTED](https://www.rfc-editor.org/rfc/rfc9114.html#H3_REQUEST_REJECTED) error code, except when a server has requested closure of the [request stream](https://www.rfc-editor.org/rfc/rfc9114.html#request-streams) with this error code.

客户端**应该**使用错误代码 H3_REQUEST_CANCELLED 来取消请求。 收到此错误代码后，如果未执行任何处理，服务器**可能**会使用错误代码 H3_REQUEST_REJECTED 突然终止响应。 客户端**不得**使用 H3_REQUEST_REJECTED 错误代码，除非服务器使用此错误代码请求关闭请求流。

> If a stream is cancelled after receiving a complete response, the client **MAY** ignore the cancellation and use the response. However, if a stream is cancelled after receiving a partial response, the response **SHOULD NOT** be used. Only idempotent actions such as GET, PUT, or DELETE can be safely retried; a client **SHOULD NOT** automatically retry a request with a non-idempotent method unless it has some means to know that the request semantics are idempotent independent of the method or some means to detect that the original request was never applied. See [Section 9.2.2](https://www.rfc-editor.org/rfc/rfc9110#section-9.2.2) of [[HTTP](https://www.rfc-editor.org/rfc/rfc9114.html#RFC9110)] for more details.

如果在收到完整响应后取消流，客户端**可以**忽略取消并使用响应。 但是，如果在收到部分响应后取消流，则**不应该**使用响应。 只有 GET、PUT 或 DELETE 等幂等操作可以安全地重试； 客户端**不应该**使用非幂等方法自动重试请求，除非它有某种方法可以知道请求语义是独立于方法的幂等，或者有某种方法可以检测到原始请求从未被应用。 有关详细信息，请参阅 [HTTP] 的第 9.2.2 节。

### 4.1.2. Malformed Requests and Responses / 格式错误的请求和响应

> A malformed request or response is one that is an otherwise valid sequence of frames but is invalid due to:
>
> - the presence of prohibited fields or pseudo-header fields,
> - the absence of mandatory pseudo-header fields,
> - invalid values for pseudo-header fields,
> - pseudo-header fields after fields,
> - an invalid sequence of HTTP messages,
> - the inclusion of uppercase field names, or
> - the inclusion of invalid characters in field names or values.

格式错误的请求或响应是一个原本有效的帧序列，但由于以下原因而无效：

- 禁止字段或伪首部字段的存在，
- 缺失强制性的伪首部字段，
- 伪首部字段的无效值，
- 字段后的伪首部字段，
- 无效的 HTTP 消息序列，
- 包含大写字段名称，或
- 在字段名称或值中包含无效字符。

> A request or response that is defined as having content when it contains a Content-Length header field ([Section 8.6](https://www.rfc-editor.org/rfc/rfc9110#section-8.6) of [[HTTP](https://www.rfc-editor.org/rfc/rfc9114.html#RFC9110)]) is malformed if the value of the Content-Length header field does not equal the sum of the [DATA](https://www.rfc-editor.org/rfc/rfc9114.html#frame-data) frame lengths received. A response that is defined as never having content, even when a Content-Length is present, can have a non-zero Content-Length header field even though no content is included in [DATA](https://www.rfc-editor.org/rfc/rfc9114.html#frame-data) frames.

如果 Content-Length 首部字段的值不等于收到的 DATA 帧长度的总和，则将这个包含 Content-Length 首部字段（[HTTP] 的第 8.6 节）的请求或响应定义为格式不正确。被定义为从不包含内容的响应，即使存在 Content-Length，也可以具有非零的 Content-Length 首部字段，即使 DATA 帧中不包含任何内容。

> Intermediaries that process HTTP requests or responses (i.e., any intermediary not acting as a tunnel) **MUST NOT** forward a malformed request or response. Malformed requests or responses that are detected **MUST** be treated as a [stream error](https://www.rfc-editor.org/rfc/rfc9114.html#errors) of type [H3_MESSAGE_ERROR](https://www.rfc-editor.org/rfc/rfc9114.html#H3_MESSAGE_ERROR).

处理 HTTP 请求或响应的中介（即任何不充当隧道的中介）**一定不能**转发格式错误的请求或响应。 检测到的格式错误的请求或响应**必须**被视为 H3_MESSAGE_ERROR 类型的流错误。

> For malformed requests, a server **MAY** send an HTTP response indicating the error prior to closing or resetting the stream. Clients **MUST NOT** accept a malformed response. Note that these requirements are intended to protect against several types of common attacks against HTTP; they are deliberately strict because being permissive can expose implementations to these vulnerabilities.

对于格式错误的请求，服务器**可以**在关闭或重置流之前发送一个 HTTP 响应以指出错误。 客户端**不得**接受格式错误的响应。 请注意，这些要求旨在防止针对 HTTP 的几种常见攻击； 它们是故意严格的，因为对这些要求宽松可能会使实现暴露于这些漏洞。

## 4.2. HTTP Fields / HTTP 字段